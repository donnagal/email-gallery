<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Email Campaign Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9fafb;
    margin: 20px;
    color: #333;
  }
  h1 {
    margin-bottom: 12px;
    color: #2c3e50;
  }
  .dashboard {
    margin-bottom: 20px;
    font-size: 16px;
  }
  .dashboard p {
    margin: 4px 0;
  }
  input[type="search"] {
    margin-bottom: 15px;
    padding: 7px 10px;
    width: 300px;
    border: 1.5px solid #ccc;
    border-radius: 4px;
    font-size: 15px;
    transition: border-color 0.3s;
  }
  input[type="search"]:focus {
    border-color: #2c7be5;
    outline: none;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    background: white;
    box-shadow: 0 0 8px rgba(0,0,0,0.05);
    border-radius: 5px;
    overflow: hidden;
  }
  thead {
    background-color: #2c7be5;
    color: white;
  }
  th, td {
    padding: 10px 14px;
    border-bottom: 1px solid #eaeaea;
    text-align: left;
    user-select: none;
  }
  th {
    cursor: pointer;
    position: relative;
    font-weight: 600;
    white-space: nowrap;
  }
  th.sort-asc::after,
  th.sort-desc::after {
    content: '';
    position: absolute;
    right: 8px;
    top: 50%;
    width: 0; 
    height: 0; 
    border-style: solid;
    transform: translateY(-50%);
  }
  th.sort-asc::after {
    border-width: 6px 5px 0 5px;
    border-color: #fff transparent transparent transparent;
  }
  th.sort-desc::after {
    border-width: 0 5px 6px 5px;
    border-color: transparent transparent #fff transparent;
  }
  tbody tr:hover {
    background: #f1f8ff;
  }
  tfoot td {
    font-weight: 700;
    background: #f0f0f0;
    font-size: 15px;
  }
  .loading {
    font-size: 16px;
    color: #666;
  }
</style>
</head>
<body class="bg-gray-200 ">
<div id="app">
  <h1>Email Campaign Dashboard</h1>

  <div class="dashboard" v-if="lists.length">
    <p><strong>Avg Unique Opens %:</strong> {{ totals.openAvg }}%</p>
    <p><strong>Avg Unique Clicks %:</strong> {{ totals.clickAvg }}%</p>
    <p><strong>Total Delivered:</strong> {{ totals.delivered }}</p>
  </div>

  <input
    type="search"
    placeholder="Search Campaign Name..."
    v-model="searchTerm"
    aria-label="Search campaigns"
  />

  <table v-if="filteredAndSorted.length">
    <thead>
      <tr>
        <th
          @click="sortBy('label')"
          :class="sortKey === 'label' ? ('sort-' + sortOrder) : ''"
          scope="col"
        >Campaign Name</th>
        <th
          @click="sortBy('day')"
          :class="sortKey === 'day' ? ('sort-' + sortOrder) : ''"
          scope="col"
        >Send Date</th>
        <th
          @click="sortBy('brand')"
          :class="sortKey === 'brand' ? ('sort-' + sortOrder) : ''"
          scope="col"
        >brand</th>
        <th
          @click="sortBy('type')"
          :class="sortKey === 'type' ? ('sort-' + sortOrder) : ''"
          scope="col"
        >Campaign Type</th>
        <th
          @click="sortBy('unique-opens-pc')"
          :class="sortKey === 'unique-opens-pc' ? ('sort-' + sortOrder) : ''"
          scope="col"
        >Unique Opens %</th>
        <th
          @click="sortBy('unique-clicks-pc')"
          :class="sortKey === 'unique-clicks-pc' ? ('sort-' + sortOrder) : ''"
          scope="col"
        >Unique Clicks %</th>
        <th
          @click="sortBy('delivered')"
          :class="sortKey === 'delivered' ? ('sort-' + sortOrder) : ''"
          scope="col"
        >Delivered</th>
        <th
          @click="sortBy('unsub')"
          :class="sortKey === 'unsub' ? ('sort-' + sortOrder) : ''"
          scope="col"
        >Unsub</th>
      </tr>
    </thead>
    <tbody>
      <tr v-for="(item, index) in filteredAndSorted" :key="index">
        <td>{{ item.label }}</td>
        <td>{{ item.day }}</td>
        <td>{{ item.brand }}</td>
        <td>{{ item.type }}</td>
        <td>{{ item['unique-opens-pc'].toFixed(2) }}%</td>
        <td>{{ item['unique-clicks-pc'].toFixed(2) }}%</td>
        <td>{{ item.delivered.toLocaleString() }}</td>
        <td>{{ item.unsub.toLocaleString() }}</td>
      </tr>
    </tbody>
    <tfoot>
      <tr>
        <td colspan="5">Totals / Averages</td>
        <td>{{ totals.clickAvg }}%</td>
        <td>{{ totals.delivered }}</td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <p v-if="!lists.length" class="loading">Loading data, please wait...</p>
  <p v-if="lists.length && !filteredAndSorted.length" class="loading">No results found.</p>
</div>

<script>
new Vue({
  el: '#app',
  data() {
    return {
      lists: [],
      totals: {
        openAvg: 0,
        clickAvg: 0,
        delivered: 0,
      },
      sortKey: 'day',
      sortOrder: 'asc',
      searchTerm: '',
    };
  },
  computed: {
    filteredAndSorted() {
      let filtered = this.lists;

      if (this.searchTerm.trim() !== '') {
        const term = this.searchTerm.trim().toLowerCase();
        filtered = filtered.filter(item => item.label.toLowerCase().includes(term));
      }

      filtered = filtered.slice().sort((a, b) => {
        let valA = a[this.sortKey];
        let valB = b[this.sortKey];

        if (this.sortKey === 'day') {
          valA = new Date(valA);
          valB = new Date(valB);
          if (isNaN(valA)) valA = new Date(0);
          if (isNaN(valB)) valB = new Date(0);
        }

        if (['unique-opens-pc', 'unique-clicks-pc', 'delivered', 'unsub'].includes(this.sortKey)) {
          valA = Number(valA);
          valB = Number(valB);
        }

        if (valA < valB) return this.sortOrder === 'asc' ? -1 : 1;
        if (valA > valB) return this.sortOrder === 'asc' ? 1 : -1;
        return 0;
      });

      return filtered;
    },
  },
  methods: {
    async fetchExcel() {
      try {
        const response = await fetch('data/ajo-report-fy25.xlsx');
        if (!response.ok) throw new Error('Failed to load Excel file');
        const arrayBuffer = await response.arrayBuffer();
        this.parseExcel(arrayBuffer);
      } catch (error) {
        console.error('Error fetching Excel file:', error);
      }
    },
    parseExcel(data) {
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      let jsonData = XLSX.utils.sheet_to_json(worksheet);

      jsonData = jsonData.map(row => ({
        label: row['Campaign Name'] || row['name'] || '',
        day: this.formatDate(row['Send Date'] || row['date']),
        brand: row['brand'] || '',
        type: row['Campaign Type'] || row['type'] || '',
        'unique-opens-pc': Number(row['Unique Opens %'] || row['unique-opens-pc'] || 0),
        'unique-clicks-pc': Number(row['Unique Clicks %'] || row['unique-clicks-pc'] || 0),
        delivered: Number(String(row['deliveried'] || row['Delivered'] || 0).replace(/,/g, '')) || 0,
        unsub: Number(String(row['unsub'] || 0).replace(/,/g, '')) || 0,
      }));

      this.lists = jsonData;
      this.calculateTotals();
    },
    formatDate(dateValue) {
      if (!dateValue) return '';

      // If it's a number (Excel serial date), convert it
      if (typeof dateValue === 'number') {
        const jsDate = this.excelDateToJSDate(dateValue);
        if (!jsDate || isNaN(jsDate)) return '';
        return jsDate.toLocaleDateString('en-AU', { day: '2-digit', month: 'short', year: '2-digit' });
      }

      // Otherwise, parse as string date
      const d = new Date(dateValue);
      if (isNaN(d)) return dateValue;
      return d.toLocaleDateString('en-AU', { day: '2-digit', month: 'short', year: '2-digit' });
    },
    excelDateToJSDate(serial) {
      if (typeof serial !== 'number') return null;
      const utc_days = serial - 25569;
      const utc_value = utc_days * 86400;
      const date_info = new Date(utc_value * 1000);
      return date_info;
    },
    calculateTotals() {
      if (!this.lists.length) {
        this.totals.openAvg = 0;
        this.totals.clickAvg = 0;
        this.totals.delivered = 0;
        return;
      }

      let totalDelivered = 0;
      let totalOpens = 0;
      let totalClicks = 0;

      this.lists.forEach(item => {
        totalDelivered += item.delivered;
        totalOpens += item['unique-opens-pc'];
        totalClicks += item['unique-clicks-pc'];
      });

      this.totals.delivered = totalDelivered.toLocaleString();
      this.totals.openAvg = (totalOpens / this.lists.length).toFixed(2);
      this.totals.clickAvg = (totalClicks / this.lists.length).toFixed(2);
    },
    sortBy(key) {
      if (this.sortKey === key) {
        this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        this.sortKey = key;
        this.sortOrder = 'asc';
      }
    }
  },
  mounted() {
    this.fetchExcel();
  }
});
</script>
</body>
</html>
